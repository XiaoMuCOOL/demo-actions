(window.webpackJsonp=window.webpackJsonp||[]).push([[35],{482:function(e,a,t){"use strict";t.r(a);var r=t(1),s=Object(r.a)({},(function(){var e=this,a=e._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("p",[e._v("K3S 基本介绍。")]),e._v(" "),a("h2",{attrs:{id:"简介"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#简介"}},[e._v("#")]),e._v(" 简介")]),e._v(" "),a("h3",{attrs:{id:"安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安装"}},[e._v("#")]),e._v(" 安装")]),e._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 国内")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("export")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("INSTALL_K3S_EXEC")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"--docker"')]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("export")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("K3S_NODE_NAME")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("pai-uat\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 用于将 server 或 agent 加入集群的共享 secret")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# export K3S_TOKEN=")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 设置了 K3S_URL，它将默认为“agent”。如果未设置K3S_URL，它将默认为“server”")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# export K3S_URL=")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("curl")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-sfL")]),e._v(" https://rancher-mirror.rancher.cn/k3s/k3s-install.sh "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("INSTALL_K3S_MIRROR")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("cn "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("sh")]),e._v(" -\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 查看安装状态")]),e._v("\nk3s kubectl get nodes\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 获取服务器token")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("sudo")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("cat")]),e._v(" /var/lib/rancher/k3s/server/node-token\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("#### node节点")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# pai-uat")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("curl")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-sfL")]),e._v(" https://rancher-mirror.rancher.cn/k3s/k3s-install.sh "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("INSTALL_K3S_MIRROR")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("cn "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("K3S_URL")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("https://47.116.185.125:6443 "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("K3S_TOKEN")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("K10079c5ea9ef1f946802293ddcb49e674eabb24ee5ee31715efb7fc8fb4239ab11::server:21722011e203fc101d886bb49f77979b "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("sh")]),e._v(" - --system-default-registry "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"https://dockerproxy.net"')]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# pai-api 172.28.95.181 139.224.45.9")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("curl")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-sfL")]),e._v(" https://rancher-mirror.rancher.cn/k3s/k3s-install.sh "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("INSTALL_K3S_MIRROR")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("cn "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("K3S_URL")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("https://139.224.45.9:6443 "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("K3S_TOKEN")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("K10c43088886544d0d4ad2be78502d691291e14acd94ec0ecbec918686d0bdfb255::server:e544c7e219ec32e2fa72cc76f7dc5c78 "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("sh")]),e._v(" -\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# pai-srv 172.28.95.187 106.14.43.112")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("curl")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-sfL")]),e._v(" https://rancher-mirror.rancher.cn/k3s/k3s-install.sh "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("INSTALL_K3S_MIRROR")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("cn "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("K3S_URL")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("https://106.14.43.112:6443 "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("K3S_TOKEN")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("K105abb45f1cbfbdc91b1c9d99e5e3d4645ef674dcc91a856abc10fe34e9725abdb::server:15bd3579a84b3fd4e08038cc3e3ea39c "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("sh")]),e._v(" -\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 设置节点标签")]),e._v("\nkubectl label nodes pai-log kubernetes.io/role"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("worker\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 设置私有仓库")]),e._v("\nkubectl create secret docker-registry harbor --docker-server"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("harbor.ant-lord.com --docker-username"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("robot"),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$gitlabci")]),e._v(" --docker-password"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("Dq17Su75M1SlAVdiHPlGawW5qhxXTBXt\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 删除k3s")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 对于master节点：")]),e._v("\n/usr/local/bin/k3s-uninstall.sh\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 对于agent节点：")]),e._v("\n/usr/local/bin/k3s-agent-uninstall.sh\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 主节点踢掉")]),e._v("\nk3s kubectl drain pai-log --ignore-daemonsets --delete-emptydir-data\nk3s kubectl delete "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("node")]),e._v(" pai-log\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 在主节点查看node安装状态")]),e._v("\nk3s kubectl get nodes\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 查看某个服务的状态")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("sudo")]),e._v(" kubectl get pods "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-n")]),e._v(" portainer\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 安装helm")]),e._v("\nsnap "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("install")]),e._v(" helm "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("--classic")]),e._v("\nhelm repo update\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("export")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("KUBECONFIG")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("/etc/rancher/k3s/k3s.yaml\nhelm upgrade "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("--install")]),e._v(" ingress-nginx ingress-nginx "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("--repo")]),e._v(" https://kubernetes.github.io/ingress-nginx "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("--namespace")]),e._v(" ingress-nginx --create-namespace\n\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 查看集群的运行情况")]),e._v("\nkubectl get nodes "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-owide")]),e._v("\nkubectl get all "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-A")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-owide")]),e._v("\nkubectl api-resources "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-o")]),e._v(" wide\nkubectl describe nodes k3s-node-01\nkubectl "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-n")]),e._v(" kube-system describe deploy coredns\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 安装")]),e._v("\nkubectl apply "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-f")]),e._v(" https://downloads.portainer.io/ce2-20/portainer-agent-k8s-lb.yaml\nkubectl delete "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-f")]),e._v(" https://downloads.portainer.io/ce2-20/portainer-agent-k8s-lb.yaml\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("sudo")]),e._v(" kubectl get pods "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-n")]),e._v(" portainer\nkubectl describe pod "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-n")]),e._v(" portainer portainer-agent-694c6ddbd5-w6p7k\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 如果遇见docker.io/rancher/mirrored-pause:3.6报错，则执行")]),e._v("\nkubectl get pods "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-n")]),e._v(" kube-system\nkubectl describe pod "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-n")]),e._v(" kube-system svclb-traefik-7c1e2c3e-r6zg8\n"),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("docker")]),e._v(" pull dockerproxy.net/rancher/mirrored-coredns-coredns:1.12.0\n"),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("docker")]),e._v(" pull harbor.ant-lord.com/library/portainer-agent:2.20.3\n"),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("docker")]),e._v(" pull dockerproxy.net/rancher/mirrored-pause:3.6\n"),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("docker")]),e._v(" pull dockerproxy.net/rancher/klipper-lb:v0.4.9\n"),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("docker")]),e._v(" pull dockerproxy.net/bitnami/etcd:3.5\n"),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("docker")]),e._v(" pull dockerproxy.net/rancher/klipper-helm:v0.9.3-build20241008\n"),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("docker")]),e._v(" tag dockerproxy.net/rancher/mirrored-coredns-coredns:1.12.0 rancher/mirrored-coredns-coredns:1.12.0\n"),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("docker")]),e._v(" tag harbor.ant-lord.com/library/portainer-agent:2.20.3 portainer/agent:2.20.3\n"),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("docker")]),e._v(" tag dockerproxy.net/rancher/mirrored-pause:3.6 rancher/mirrored-pause:3.6\n"),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("docker")]),e._v(" tag dockerproxy.net/rancher/klipper-lb:v0.4.9 rancher/klipper-lb:v0.4.9\n"),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("docker")]),e._v(" tag dockerproxy.net/bitnami/etcd:3.5 bitnami/etcd:3.5\n"),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("docker")]),e._v(" tag dockerproxy.net/rancher/klipper-helm:v0.9.3-build20241008 rancher/klipper-helm:v0.9.3-build20241008\n"),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("docker")]),e._v(" rmi dockerproxy.net/rancher/mirrored-coredns-coredns:1.12.0 harbor.ant-lord.com/library/portainer-agent:2.20.3 dockerproxy.net/rancher/mirrored-pause:3.6 dockerproxy.net/rancher/klipper-lb:v0.4.9 dockerproxy.net/bitnami/etcd:3.5\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("docker")]),e._v(" pull harbor.ant-lord.com/library/portainer-agent:2.20.3\n"),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("docker")]),e._v(" tag harbor.ant-lord.com/library/portainer-agent:2.20.3 portainer/agent:2.20.3\n"),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("docker")]),e._v(" rmi harbor.ant-lord.com/library/portainer-agent:2.20.3\n\n")])])]),a("h2",{attrs:{id:"常用功能"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#常用功能"}},[e._v("#")]),e._v(" 常用功能")]),e._v(" "),a("h1",{attrs:{id:"删除pod重新创建"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#删除pod重新创建"}},[e._v("#")]),e._v(" 删除pod重新创建")]),e._v(" "),a("p",[e._v("kubectl delete pod portainer-agent-694c6ddbd5-l6667 -n portainer\nkubectl delete -n kube-system pod coredns-ccb96694c-qm72l")]),e._v(" "),a("h1",{attrs:{id:"查看deployment"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#查看deployment"}},[e._v("#")]),e._v(" 查看deployment")]),e._v(" "),a("p",[e._v("kubectl get deployments -n kube-system\nkubectl edit deployment coredns -n kube-system\nkubectl describe pod -n kube-system coredns-667bcf6fbf-j8hqm")]),e._v(" "),a("h3",{attrs:{id:"添加其他服务器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#添加其他服务器"}},[e._v("#")]),e._v(" 添加其他服务器")]),e._v(" "),a("p",[e._v("操作路径：")]),e._v(" "),a("blockquote",[a("ul",[a("li",[e._v("Environments -> add environment -> Agent -> Docker Swarm")])])])])}),[],!1,null,null,null);a.default=s.exports}}]);