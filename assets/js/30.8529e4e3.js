(window.webpackJsonp=window.webpackJsonp||[]).push([[30],{420:function(a,t,s){"use strict";s.r(t);var n=s(1),e=Object(n.a)({},(function(){var a=this,t=a._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[t("p",[a._v("Gitlab 相关的一些安装、命令、操作记录。")]),a._v(" "),t("h2",{attrs:{id:"安装-gitlab"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#安装-gitlab"}},[a._v("#")]),a._v(" 安装 gitlab")]),a._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("apt")]),a._v(" update               // 更新软件源\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("apt")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("install")]),a._v(" docker.io "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-y")]),a._v(" // 安装docker\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" pull gitlab/gitlab-ee:latest  // 拉取镜像\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" run "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-d")]),a._v("  "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("443")]),a._v(":443 "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("80")]),a._v(":80 "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("222")]),a._v(":22 "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--name")]),a._v(" gitlab "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--restart")]),a._v(" always "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" /home/gitlab/config:/etc/gitlab "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" /home/gitlab/logs:/var/log/gitlab "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" /home/gitlab/data:/var/opt/gitlab gitlab/gitlab-ee:latest\n")])])]),t("p",[a._v("gitlab结果："),t("code",[a._v("6e6b93f21e379e40a50a2468025d10d82067d9c0a6635ac0fe1090fc59fd4c4b")])]),a._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("vim")]),a._v(" /home/gitlab/config/gitlab.rb\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 配置http协议所使用的访问地址,不加端口号默认为80")]),a._v("\nexternal_url "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'http://47.103.58.85'")]),a._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 配置ssh协议所使用的访问地址和端口")]),a._v("\ngitlab_rails"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'gitlab_ssh_host'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'47.103.58.85'")]),a._v("\ngitlab_rails"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'gitlab_shell_ssh_port'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("22")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 此端口是run时22端口映射的22端口")]),a._v("\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" restart gitlab\n")])])]),t("p",[a._v("gitlab 用户名:root  初始密码：在config里")]),a._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" run "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-d")]),a._v("  "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("443")]),a._v(":443 "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("80")]),a._v(":80 "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("222")]),a._v(":22 "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--name")]),a._v(" gitlab-ce "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--restart")]),a._v(" always "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" /home/gitlab/config:/etc/gitlab "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" /home/gitlab/logs:/var/log/gitlab "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" /home/gitlab/data:/var/opt/gitlab gitlab/gitlab-ce:latest\n")])])]),t("p",[a._v("结果："),t("code",[a._v("3125c038a09574b76a390dcda2a895b2f2402b7b78b5451891ece17358a1b510")])]),a._v(" "),t("h1",{attrs:{id:"启动-重启-runner"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#启动-重启-runner"}},[a._v("#")]),a._v(" 启动/重启 Runner")]),a._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" run "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-d")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("8093")]),a._v(":8093 "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--name")]),a._v(" gitlab-runner "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--restart")]),a._v(" always "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n     "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" /home/gitlab-runner/config:/etc/gitlab-runner "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n     "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" /var/run/docker.sock:/var/run/docker.sock "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n     gitlab/gitlab-runner:latest\n")])])]),t("p",[a._v("结果："),t("code",[a._v("bab6921ec13264ab84d364590f7c8bd3a3a969739a044a5abf1e67f249c043ab")])]),a._v(" "),t("h3",{attrs:{id:"注册runner"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#注册runner"}},[a._v("#")]),a._v(" 注册runner")]),a._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 手动填写参数")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" run "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--rm")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-it")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" /home/gitlab-runner/config:/etc/gitlab-runner gitlab/gitlab-runner register\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 或命令行预设参数")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v("  run "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--rm")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-it")]),a._v(" gitlab/gitlab-runner register "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-n")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n       "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--url")]),a._v(" http://47.103.58.85 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n       --registration-token tsiKxKgEm648JnzaSSMz "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n       --tag-list saas-dev"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n       "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--executor")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n       --docker-image "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n       --docker-volumes /home/gitlab-runner/.m2:/root/.m2 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n       --docker-volumes /home/gitlab-runner/.npm:/root/.npm "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n       --docker-volumes /home/gitlab-runner/config:/etc/gitlab-runner "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n       --docker-volumes /var/run/docker.sock:/var/run/docker.sock "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n       "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--description")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"docker镜像saas-prod-elk2服务器"')]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 上面两个都不行，要进入容器注册")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("exec")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-it")]),a._v(" gitlab-runner /bin/bash\ngitlab-runner register\n")])])]),t("h1",{attrs:{id:"辣鸡runner-配置要写死docker版本-不然哭死你"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#辣鸡runner-配置要写死docker版本-不然哭死你"}},[a._v("#")]),a._v(" 辣鸡runner，配置要写死docker版本，不然哭死你")]),a._v(" "),t("p",[t("code",[a._v("/home/gitlab-runner/config/config.toml")])]),a._v(" "),t("div",{staticClass:"language-YML extra-class"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[a._v("concurrent = 4      "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 并发运行数量，建议设置为CPU数量")]),a._v("\ncheck_interval = 0\n\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("session_server"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v("\n  session_timeout = 1800\n\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("runners"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v('\n  name = "docker镜像saas'),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v('dev服务器"\n  url = "http'),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v('//47.103.58.85"\n  token = "tsiKxKgEm648JnzaSSMz"\n  executor = "docker"\n  '),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("runners.custom_build_dir"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("runners.cache"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("runners.cache.s3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("runners.cache.gcs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("runners.cache.azure"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("runners.docker"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v('\n    tls_verify = false\n    image = "docker'),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v('19.03.12"\n    privileged = true\n    disable_entrypoint_overwrite = false\n    oom_kill_disable = false\n    disable_cache = false\n    volumes = '),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"/var/run/docker.sock:/var/run/docker.sock"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"/cache"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v("\n    shm_size = 0\n")])])]),t("h3",{attrs:{id:"验证runner"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#验证runner"}},[a._v("#")]),a._v(" 验证runner")]),a._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" run "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--rm")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-it")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" /home/gitlab-runner/config:/etc/gitlab-runner gitlab/gitlab-runner verify\n")])])]),t("h3",{attrs:{id:"清理gitlab-prometheus-磁盘占用过大"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#清理gitlab-prometheus-磁盘占用过大"}},[a._v("#")]),a._v(" 清理gitlab prometheus 磁盘占用过大")]),a._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 清理 docker 日志")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("cat")]),a._v(" /dev/null "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" /var/lib/docker/containers/8bd86f42a9a4ec56bf08718f49cf939ad4fa038ca786deda6ae637f998addb0b/8bd86f42a9a4ec56bf08718f49cf939ad4fa038ca786deda6ae637f998addb0b-json.log\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 清理 gitlab 日志")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("exec")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-it")]),a._v(" gitlab /bin/bash\ngitlab-ctl stop prometheus\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("rm")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-rf")]),a._v(" /var/opt/gitlab/prometheus/data/*\ngitlab-ctl start prometheus\n")])])]),t("h2",{attrs:{id:"gitlab-ci-配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#gitlab-ci-配置"}},[a._v("#")]),a._v(" Gitlab-CI 配置")]),a._v(" "),t("p",[t("a",{attrs:{href:"https://docs.gitlab.cn/jh/ci/yaml/index.html",target:"_blank",rel:"noopener noreferrer"}},[a._v(".gitlab-ci.yml"),t("OutboundLink")],1)]),a._v(" "),t("div",{staticClass:"language-yml extra-class"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 默认")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("default")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 默认镜像")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("image")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" ruby"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("3.0")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 如果要启动运行命令或脚本")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("image")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 镜像名称")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" ruby"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("2.6")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 命令或脚本")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("entrypoint")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"/bin/bash"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 额外的 Docker 镜像来运行脚本。services 镜像链接到 image 关键字中指定的镜像")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("services")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" my"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("postgres"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("11.7")]),a._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("alias")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" db"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("postgres\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("entrypoint")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"/usr/local/bin/db-postgres"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("command")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"start"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 阶段")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("stages")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 阶段名称")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" build\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" test\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 自定义变量")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("variables")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 变量 key: value")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("DEPLOY_VARIABLE")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"default-deploy"')]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 流水线")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("workflow")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 规则")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("rules")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 具体规则")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("if")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'$CI_PIPELINE_SOURCE == \"schedule\"'")]),a._v("\n      "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 当 IF 为 true 时，是否执行流水线")]),a._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("when")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" never\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("if")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'$CI_PIPELINE_SOURCE == \"push\"'")]),a._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("when")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" never\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 除了上面指定的规则是 never，其他都是 always")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("when")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" always\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 作业/任务")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("job1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 所属阶段")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("stage")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" build\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 镜像")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("image")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" ruby"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("3")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 规则")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("rules")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("if")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'$CI_MERGE_REQUEST_SOURCE_BRANCH_NAME =~ /^feature/ && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME != $CI_DEFAULT_BRANCH'")]),a._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("when")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" never\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("if")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'$CI_MERGE_REQUEST_SOURCE_BRANCH_NAME =~ /^feature/'")]),a._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("when")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" manual\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("allow_failure")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token boolean important"}},[a._v("true")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("if")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'$CI_MERGE_REQUEST_SOURCE_BRANCH_NAME'")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 执行脚本")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("script")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(' echo "Check the ruby version'),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" then build some Ruby project files"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v('"\n    '),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" ruby "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("v\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" rake\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 作业/任务")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("job2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("stage")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" test\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("script")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(' echo "If the files are built successfully'),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" test other files with a different command"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v('"\n    '),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" rake test2\n\n")])])])])}),[],!1,null,null,null);t.default=e.exports}}]);