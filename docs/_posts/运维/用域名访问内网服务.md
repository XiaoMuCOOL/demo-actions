---
category: 运维
tags:
  - Jira
  - Confluence
date: 2024-05-23
permalink: /devlop/jira.html
title: 用域名访问内网服务
---

用域名访问内网服务Jira和Confluence相关的操作记录。

<!-- more -->

## 安装

参考：[colin-chang\jira-confluence][0],实际用的是[haxqer][1]大神的开源镜像。

### 更改 Confluence 域名访问

1. 修改 Confluence 配置：

```shell
// 进入容器
$ docker exec -it atlassian-confluence /bin/bash
// 查看 Confluence 配置文件
$ cd /opt/confluence/conf/
$ cat ./server.xml
```
我们可以看到配置文件里有demo，首先注释原来的`10`-`13`行，再把`29`-`33`行注释打开修改下域名就好:

```xml
<Connector port="8090" connectionTimeout="20000" redirectPort="8443"
                   maxThreads="48" minSpareThreads="10"
                   enableLookups="false" acceptCount="10" debug="0" URIEncoding="UTF-8"
                   protocol="org.apache.coyote.http11.Http11NioProtocol"
                   scheme="http" proxyName="wiki.ant-lord.com" proxyPort="80"/>
```

因为容器内没有vi工具，所以在宿主机改好后传到容器内：
```shell
// 先备份下配置文件
$ cp server.xml server.xml_bat
// 在宿主机下用docker 命令把文件传送到容器内
$ docker cp /home/server.xml atlassian-confluence:/opt/confluence/conf/server.xml
// 重启容器
$ docker restart atlassian-confluence
```

配置改好后，修改宿主机下的Nginx配置：

```nginx
# Confluence 配置
server {
    listen       80;
    server_name  wiki.ant-lord.com;
    # ssl_certificate      /home/wiki.ant-lord.com.pem;
    # ssl_certificate_key  /home/wiki.ant-lord.com.key;
    # ssl_session_cache    shared:SSL:10m;
    # ssl_session_timeout  5m;
    # ssl_ciphers               ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;
    # ssl_protocols             TLSv1 TLSv1.1 TLSv1.2;
    # ssl_prefer_server_ciphers on;
    client_max_body_size 10M;

    location / {
        proxy_pass http://192.168.1.17:8090/;
    }
}
```
重启Nginx

```shell
$ nginx -s reload
```

最后在Confluence 页面上修改基本URL，修改路径：`设置->一般配置->站点配置->服务器主页URL` 修改为：`http://wiki.ant-lord.com` 就可以了。


[0]:https://github.com/colin-chang/jira-confluence
[1]:https://github.com/haxqer